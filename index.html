<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    let selectedFiles = [];
    const maxFiles = 5;
    const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100 –ú–ë
    const BATCH_SIZE = 10; // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ 10 —Å—Ç—Ä–∞–Ω–∏—Ü –∑–∞ —Ä–∞–∑
    
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const fileList = document.getElementById('fileList');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loader = document.getElementById('loader');
    const results = document.getElementById('results');
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
    fileInput.addEventListener('change', handleFileSelect);
    
    // Drag & Drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
        addFiles(files);
    });
    
    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        addFiles(files);
    }
    
    function addFiles(files) {
        files.forEach(file => {
            if (file.size > MAX_FILE_SIZE) {
                alert(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 100 –ú–ë)`);
                return;
            }
            
            if (selectedFiles.length < maxFiles && !selectedFiles.some(f => f.name === file.name)) {
                selectedFiles.push(file);
            }
        });
        
        updateFileList();
        analyzeBtn.disabled = selectedFiles.length < 2;
    }
    
    function updateFileList() {
        fileList.innerHTML = '';
        
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
            fileItem.innerHTML = `
                <span class="file-name">üìÑ ${file.name} (${sizeInMB} –ú–ë)</span>
                <button class="remove-btn" onclick="removeFile(${index})">–£–¥–∞–ª–∏—Ç—å</button>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
        analyzeBtn.disabled = selectedFiles.length < 2;
    }
    
    // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ï –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
    async function extractTextFromPDFOptimized(file, progressCallback) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({
            data: arrayBuffer,
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
            disableFontFace: true,      // –û—Ç–∫–ª—é—á–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —à—Ä–∏—Ñ—Ç–æ–≤
            cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
            cMapPacked: true,
        }).promise;
        
        let fullText = '';
        const totalPages = pdf.numPages;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ –±–∞—Ç—á–∞–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
        for (let i = 1; i <= totalPages; i += BATCH_SIZE) {
            const batchPromises = [];
            const batchEnd = Math.min(i + BATCH_SIZE - 1, totalPages);
            
            for (let pageNum = i; pageNum <= batchEnd; pageNum++) {
                batchPromises.push(
                    pdf.getPage(pageNum).then(async (page) => {
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        
                        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                        page.cleanup();
                        
                        return pageText;
                    })
                );
            }
            
            const batchTexts = await Promise.all(batchPromises);
            fullText += batchTexts.join(' ');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = Math.round((batchEnd / totalPages) * 100);
            progressCallback(file.name, progress);
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
            if (global.gc) {
                global.gc();
            }
        }
        
        return fullText;
    }
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
    function normalizeText(text) {
        return text.toLowerCase()
                   .replace(/\s+/g, ' ')
                   .trim();
    }
    
    // –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –¥–ª–∏–Ω–µ
    function splitIntoSentences(text, maxSentences = 5000) {
        const sentences = text.split(/[.!?]+/)
                              .map(s => normalizeText(s))
                              .filter(s => s.length > 20);
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        if (sentences.length > maxSentences) {
            console.warn(`–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç ${sentences.length} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–≤—ã–µ ${maxSentences}.`);
            return sentences.slice(0, maxSentences);
        }
        
        return sentences;
    }
    
    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ñ–∞–∫–∫–∞—Ä–∞
    function jaccardSimilarity(set1, set2) {
        const intersection = new Set([...set1].filter(x => set2.has(x)));
        const union = new Set([...set1, ...set2]);
        return union.size === 0 ? 0 : (intersection.size / union.size) * 100;
    }
    
    // –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
    analyzeBtn.addEventListener('click', async () => {
        loader.innerHTML = `
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #667eea;" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–Ω–∞–ª–∏–∑—É...</p>
            <div style="background: #e0e0e0; border-radius: 10px; height: 20px; margin-top: 10px; overflow: hidden;">
                <div id="progressBar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <div id="fileProgress" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
        `;
        
        loader.classList.add('active');
        results.innerHTML = '';
        analyzeBtn.disabled = true;
        
        try {
            const documents = [];
            const allSentences = [];
            const sentenceToFiles = new Map();
            
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            const fileProgress = document.getElementById('fileProgress');
            
            let completedFiles = 0;
            
            // Callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            function updateProgress(fileName, percent) {
                fileProgress.innerHTML = `–û–±—Ä–∞–±–æ—Ç–∫–∞: ${fileName} (${percent}%)`;
            }
            
            // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (—ç–∫–æ–Ω–æ–º–∏–º –ø–∞–º—è—Ç—å)
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ ${i + 1} –∏–∑ ${selectedFiles.length}: ${file.name}`;
                
                const text = await extractTextFromPDFOptimized(file, updateProgress);
                const sentences = splitIntoSentences(text);
                
                documents.push({
                    name: file.name,
                    sentences: sentences,
                    sentenceSet: new Set(sentences)
                });
                
                sentences.forEach(sent => {
                    if (!sentenceToFiles.has(sent)) {
                        sentenceToFiles.set(sent, new Set());
                    }
                    sentenceToFiles.get(sent).add(file.name);
                    allSentences.push(sent);
                });
                
                completedFiles++;
                const overallProgress = Math.round((completedFiles / selectedFiles.length) * 100);
                progressBar.style.width = overallProgress + '%';
                
                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            progressText.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...';
            progressBar.style.width = '100%';
            
            // –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const commonSentences = Array.from(sentenceToFiles.entries())
                .filter(([_, files]) => files.size > 1);
            const uniqueSentences = Array.from(sentenceToFiles.entries())
                .filter(([_, files]) => files.size === 1);
            
            const commonCount = allSentences.filter(s => 
                sentenceToFiles.get(s).size > 1
            ).length;
            const uniqueCount = allSentences.length - commonCount;
            
            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ 
            let html = '<h2 style="color: #667eea; margin-bottom: 20px;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>';
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            html += '<div class="stats-grid">';
            html += `
                <div class="stat-card">
                    <div class="stat-label">–û–±—â–∏–π —Ç–µ–∫—Å—Ç</div>
                    <div class="stat-value">${(commonCount / allSentences.length * 100).toFixed(1)}%</div>
                    <div class="stat-label">${commonCount} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</div>
                    <div class="stat-value">${(uniqueCount / allSentences.length * 100).toFixed(1)}%</div>
                    <div class="stat-label">${uniqueCount} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>
                </div>
            `;
            html += '</div>';
            
            // –§–∏–ª—å—Ç—Ä—ã
            html += '<div class="filter-buttons">';
            html += '<button class="filter-btn active" onclick="filterSentences(\'all\')">–í—Å–µ</button>';
            html += '<button class="filter-btn" onclick="filterSentences(\'unique\')">–¢–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ</button>';
            html += '<button class="filter-btn" onclick="filterSentences(\'common\')">–¢–æ–ª—å–∫–æ –æ–±—â–∏–µ</button>';
            html += '</div>';
            
            // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É
            html += '<div class="differences-section">';
            html += '<h3 style="color: #667eea; margin-bottom: 20px;">üìù –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 20)</h3>';
            
            documents.forEach((doc, index) => {
                const docCommon = doc.sentences.filter(s => 
                    sentenceToFiles.get(s).size > 1
                );
                const docUnique = doc.sentences.filter(s => 
                    sentenceToFiles.get(s).size === 1
                );
                
                html += `
                    <div class="file-differences">
                        <h4 onclick="toggleSentences(${index})">
                            <span>
                                <span class="toggle-icon" id="toggle-${index}">‚ñ∂</span>
                                ${doc.name}
                                <span class="sentence-badge badge-unique">${docUnique.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</span>
                                <span class="sentence-badge badge-common">${docCommon.length} –æ–±—â–∏—Ö</span>
                            </span>
                        </h4>
                        
                        <div class="sentences-container" id="sentences-${index}">
                            <h5 style="color: #4caf50; margin-top: 15px;">‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 20):</h5>
                `;
                
                if (docUnique.length > 0) {
                    docUnique.slice(0, 20).forEach(sent => {
                        html += `<div class="sentence-item unique-sentence" data-type="unique">${sent}</div>`;
                    });
                    if (docUnique.length > 20) {
                        html += `<p style="color: #666; margin-top: 10px;">...–∏ –µ—â–µ ${docUnique.length - 20} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>`;
                    }
                } else {
                    html += '<p style="color: #666;">–ù–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>';
                }
                
                html += '<h5 style="color: #ff9800; margin-top: 20px;">üîÑ –û–±—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 20):</h5>';
                
                if (docCommon.length > 0) {
                    docCommon.slice(0, 20).forEach(sent => {
                        const files = Array.from(sentenceToFiles.get(sent));
                        const otherFiles = files.filter(f => f !== doc.name).join(', ');
                        html += `
                            <div class="sentence-item common-sentence" data-type="common">
                                ${sent}
                                <br><small style="opacity: 0.7;">–¢–∞–∫–∂–µ –≤: ${otherFiles}</small>
                            </div>
                        `;
                    });
                    if (docCommon.length > 20) {
                        html += `<p style="color: #666; margin-top: 10px;">...–∏ –µ—â–µ ${docCommon.length - 20} –æ–±—â–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>`;
                    }
                } else {
                    html += '<p style="color: #666;">–ù–µ—Ç –æ–±—â–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>';
                }
                
                html += '</div></div>';
            });
            
            html += '</div>';
            
            // –ü–æ–ø–∞—Ä–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
            html += '<div class="comparison-matrix">';
            html += '<h3 style="color: #667eea; margin-bottom: 15px;">üîÑ –ü–æ–ø–∞—Ä–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</h3>';
            
            for (let i = 0; i < documents.length; i++) {
                for (let j = i + 1; j < documents.length; j++) {
                    const similarity = jaccardSimilarity(
                        documents[i].sentenceSet,
                        documents[j].sentenceSet
                    );
                    
                    let cellClass = 'matrix-cell ';
                    if (similarity > 60) cellClass += 'similarity-high';
                    else if (similarity > 30) cellClass += 'similarity-medium';
                    else cellClass += 'similarity-low';
                    
                    html += `
                        <div class="${cellClass}">
                            <div style="font-size: 0.9em; margin-bottom: 5px;">
                                ${documents[i].name} ‚Üî ${documents[j].name}
                            </div>
                            <div style="font-size: 2em; font-weight: bold;">
                                ${similarity.toFixed(1)}%
                            </div>
                            <div style="font-size: 0.8em; opacity: 0.9;">
                                —Å—Ö–æ–∂–µ—Å—Ç–∏
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            
            results.innerHTML = html;
            
        } catch (error) {
            results.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
        } finally {
            loader.classList.remove('active');
            analyzeBtn.disabled = false;
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–∫—Ä—ã—Ç–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π 
    function toggleSentences(index) {
        const container = document.getElementById(`sentences-${index}`);
        const icon = document.getElementById(`toggle-${index}`);
        
        if (container.classList.contains('expanded')) {
            container.classList.remove('expanded');
            icon.classList.remove('expanded');
        } else {
            container.classList.add('expanded');
            icon.classList.add('expanded');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π 
    function filterSentences(type) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        document.querySelectorAll('.sentence-item').forEach(item => {
            const itemType = item.getAttribute('data-type');
            
            if (type === 'all') {
                item.style.display = 'block';
            } else if (type === 'unique' && itemType === 'unique') {
                item.style.display = 'block';
            } else if (type === 'common' && itemType === 'common') {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
</script>
